# Cilium Network Policies for Application Namespaces
# These policies allow applications to communicate while maintaining security
#
# Apply with: kubectl apply -f k8s/security/03-app-policies.yaml
---
# Production namespace - allow ingress from Knative/Kourier and internal services
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: production-ingress
  namespace: production
spec:
  description: "Allow ingress to production services"
  endpointSelector: {}
  ingress:
    # Allow traffic from Knative ingress (Kourier)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: kourier-system
    # Allow traffic from other production services
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: production
    # Allow traffic from knative-serving (for probes and activator)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: knative-serving
---
# Production namespace - allow egress to essential services
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: production-egress
  namespace: production
spec:
  description: "Allow egress from production services"
  endpointSelector: {}
  egress:
    # Allow to other production services
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: production
    # Allow to external-secrets (for secret sync)
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: external-secrets
    # Allow HTTPS to external APIs (GCP, etc)
    - toEntities:
        - world
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
    # Allow to GCP Secret Manager
    - toFQDNs:
        - matchPattern: "*.googleapis.com"
        - matchName: "secretmanager.googleapis.com"
        - matchName: "storage.googleapis.com"
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
---
# Staging namespace - similar to production but also allows dev access
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: staging-ingress
  namespace: staging
spec:
  description: "Allow ingress to staging services"
  endpointSelector: {}
  ingress:
    # Allow traffic from Knative ingress (Kourier)
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: kourier-system
    # Allow traffic from other staging services
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: staging
    # Allow traffic from knative-serving
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: knative-serving
    # Allow traffic from development for testing
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: development
---
# Staging namespace egress
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: staging-egress
  namespace: staging
spec:
  description: "Allow egress from staging services"
  endpointSelector: {}
  egress:
    # Allow to other staging services
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: staging
    # Allow to external-secrets
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: external-secrets
    # Allow HTTPS to external APIs
    - toEntities:
        - world
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
    # Allow to GCP services
    - toFQDNs:
        - matchPattern: "*.googleapis.com"
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
---
# Development namespace - more permissive for debugging
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: development-ingress
  namespace: development
spec:
  description: "Allow ingress to development services"
  endpointSelector: {}
  ingress:
    # Allow from Knative ingress
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: kourier-system
    # Allow from development namespace
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: development
    # Allow from knative-serving
    - fromEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: knative-serving
---
# Development namespace egress - more permissive
apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: development-egress
  namespace: development
spec:
  description: "Allow egress from development services"
  endpointSelector: {}
  egress:
    # Allow to development services
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: development
    # Allow to staging (for integration testing)
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: staging
    # Allow to external-secrets
    - toEndpoints:
        - matchLabels:
            io.kubernetes.pod.namespace: external-secrets
    # Allow HTTPS to external APIs
    - toEntities:
        - world
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
            - port: "80"
              protocol: TCP
    # Allow to GCP services
    - toFQDNs:
        - matchPattern: "*.googleapis.com"
      toPorts:
        - ports:
            - port: "443"
              protocol: TCP
