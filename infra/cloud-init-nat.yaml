#cloud-config
hostname: ${hostname}
package_update: true

# 1. PREVENT INSTALL HANG (The only change: Answers "Yes" to prompts automatically)
bootcmd:
  - echo iptables-persistent iptables-persistent/autosave_v4 boolean true | debconf-set-selections
  - echo iptables-persistent iptables-persistent/autosave_v6 boolean true | debconf-set-selections

packages:
  - iptables-persistent
  - curl
  - jq
  - fail2ban # <--- ADD THIS

runcmd:
  # 2. Disable UFW (Just to be safe)
  - ufw disable

  # 3. Enable IP Forwarding
  - sysctl -w net.ipv4.ip_forward=1
  - echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf

  # 4. Configure Fail2Ban (Optional but recommended)
  # Ubuntu's default fail2ban config protects SSH automatically,
  # but restarting it ensures it picks up the new environment.
  - systemctl enable fail2ban
  - systemctl restart fail2ban

  # 5. Setup Firewall Rules (Your Dynamic Detection Logic)
  - |
    # Find the interface carrying the default route (WAN)
    WAN_IFACE=$(ip route show default | awk '{print $5}' | head -n1)

    # Fallback if detection fails
    if [ -z "$WAN_IFACE" ]; then WAN_IFACE="eth0"; fi

    echo "Detected WAN Interface: $WAN_IFACE"

    iptables -F
    iptables -t nat -F
    iptables -P FORWARD ACCEPT

    # Masquerade outbound traffic
    iptables -t nat -A POSTROUTING -o "$WAN_IFACE" -j MASQUERADE

    netfilter-persistent save
    netfilter-persistent reload

  # 6. Install Tailscale
  - curl -fsSL https://tailscale.com/install.sh | sh

  # 7. Join Tailscale (Your Retry Loop)
  - echo "Starting Tailscale Join Loop..." > /var/log/tailscale-join.log
  - |
    NEXT_WAIT_TIME=0
    until tailscale up --authkey=${tailscale_auth_nat_key} \
      --ssh \
      --hostname=${hostname} \
      --advertise-tags=${tailscale_tag} \
      --reset >> /var/log/tailscale-join.log 2>&1 || [ $NEXT_WAIT_TIME -eq 12 ];
    do
       echo "Join failed. Retrying in 5 seconds..." >> /var/log/tailscale-join.log
       sleep 5
       NEXT_WAIT_TIME=$((NEXT_WAIT_TIME+1))
    done
