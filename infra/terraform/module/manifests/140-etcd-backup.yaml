apiVersion: batch/v1
kind: CronJob
metadata:
  name: talos-etcd-backup
  namespace: kube-system
spec:
  schedule: "0 */6 * * *"
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: backup
              image: amazon/aws-cli:latest
              command:
                - /bin/sh
                - -c
                - |
                  echo "Installing talosctl..."
                  curl -sL https://talos.dev/install | sh

                  SNAPSHOT_NAME="etcd-snapshot-$(date +%Y-%m-%d-%H%M%S).db"
                  SNAPSHOT_PATH="/tmp/$SNAPSHOT_NAME"

                  echo "Taking ETCD snapshot from ${K8sApiIp}..."
                  talosctl --talosconfig /etc/talos/talosconfig -n ${K8sApiIp} etcd snapshot $SNAPSHOT_PATH

                  echo "Uploading to S3..."
                  aws s3 cp $SNAPSHOT_PATH s3://${S3Bucket}/talos-backups/$SNAPSHOT_NAME \
                    --endpoint-url ${S3Endpoint} \
                    --region ${S3Region}

                  echo "Backup successful!"
              env:
                - name: AWS_ACCESS_KEY_ID
                  valueFrom:
                    secretKeyRef:
                      name: etcd-backup-s3
                      key: access-key
                - name: AWS_SECRET_ACCESS_KEY
                  valueFrom:
                    secretKeyRef:
                      name: etcd-backup-s3
                      key: secret-key
              volumeMounts:
                - name: talosconfig-mount
                  mountPath: /etc/talos
                  readOnly: true
          volumes:
            - name: talosconfig-mount
              secret:
                secretName: talos-admin-config
          restartPolicy: OnFailure
