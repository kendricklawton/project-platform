apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: ingress-nginx
  namespace: kube-system
spec:
  repo: https://kubernetes.github.io/ingress-nginx
  chart: ingress-nginx
  targetNamespace: kube-system
  version: "${IngressNginxVersion}"
  bootstrap: true
  valuesContent: |-
    controller:
      # High Availability
      # Using a DaemonSet ensures an ingress controller runs on every worker node.
      kind: DaemonSet

  service:
    enabled: true
    # Type NodePort is required so the external Cloud Load Balancer can route
    # traffic directly to the pods on each node.
    type: NodePort

  # Resource Management
  # Prevents a single high-traffic app from crashing the entire node.
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 256Mi

  # --- PLATFORM CONFIGURATION ---
  config:
    # 1. Real IP Preservation (Proxy Protocol)
    # Essential for seeing actual visitor IPs through the Hetzner LB.
    use-proxy-protocol: "true"
    real-ip-header: "proxy_protocol"
    set-real-ip-from: "${VpcCidr}"

    # 2. Security Hardening (CKS Best Practices)
    server-tokens: "false" # Hides Nginx version
    generate-request-id: "true" # Adds X-Request-ID for Vercel-style tracing
    hsts: "true" # Forces HTTPS
    hsts-max-age: "31536000"

    # 3. Performance & Modern Protocols
    use-http2: "true"
    use-gzip: "true"
    gzip-types: "text/plain application/javascript application/x-javascript text/javascript text/xml text/css application/json"

    # 4. Global Rate Limiting (DDoS Protection)
    limit-connections: "20"
    limit-rps: "10"
    limit-burst-multiplier: "5"

    # 5. Vercel-style Observability (JSON Logging)
    # Optimized for ingestion by Fluent-bit, Loki, or Datadog.
    log-format-upstream: >-
      {
        "time": "$time_iso8601",
        "remote_addr": "$proxy_protocol_addr",
        "x-forward-for": "$proxy_add_x_forwarded_for",
        "request_id": "$req_id",
        "status": $status,
        "vhost": "$host",
        "path": "$uri",
        "method": "$request_method",
        "duration": $request_time,
        "user_agent": "$http_user_agent"
      }

  # --- ERROR HANDLING ---
  # Allows your platform to serve branded 404/500 pages instead of raw Nginx screens.
  custom-http-errors: "404,500,503"

  # --- METRICS ---
  # Enabling these allows Prometheus to scrape the controller for Grafana dashboards.
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
