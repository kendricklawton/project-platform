#cloud-config
hostname: ${hostname}
manage_etc_hosts: true

write_files:
  # --- gVisor Config ---
  - path: /var/lib/rancher/k3s/agent/etc/containerd/config.toml.tmpl
    permissions: "0644"
    content: |
      [plugins.opt]
        path = "{{ .NodeConfig.Containerd.Opt }}"
      [plugins.cri]
        stream_server_address = "127.0.0.1"
        stream_server_port = "10010"
        enable_selinux = {{ .NodeConfig.SELinux }}
      [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runsc]
        runtime_type = "io.containerd.runsc.v1"

runcmd:
  # Time Sync
  - systemctl enable systemd-timesyncd
  - systemctl start systemd-timesyncd
  - timedatectl set-ntp true

  # Run Bootstrap Binary
  - echo "=== Starting Agent Node Bootstrap ==="
  - >
    /usr/local/bin/infra-bootstrap
    --role agent
    --hostname "${hostname}"
    --cloud-env "${cloud_env}"
    --k3s-token "${k3s_token}"
    --k3s-url "${k3s_url}"
    --tailscale-auth-key "${tailscale_auth_agent_key}"
    --tailscale-tag "${tailscale_tag}"
  - echo "=== Agent Node Bootstrap Complete ==="
