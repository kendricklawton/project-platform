#cloud-config
hostname: ${hostname}
manage_etc_hosts: true

write_files:
  # --- gVisor Config ---
  - path: /var/lib/rancher/k3s/agent/etc/containerd/config.toml.tmpl
    permissions: "0644"
    content: |
      [plugins.opt]
        path = "{{ .NodeConfig.Containerd.Opt }}"
      [plugins.cri]
        stream_server_address = "127.0.0.1"
        stream_server_port = "10010"
        enable_selinux = {{ .NodeConfig.SELinux }}
      [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runsc]
        runtime_type = "io.containerd.runsc.v1"

runcmd:
  # 1. Time Sync
  - systemctl enable systemd-timesyncd
  - systemctl start systemd-timesyncd
  - timedatectl set-ntp true

  # 2. CRITICAL FIX: Ensure Default Route Exists
  - |
    sh -c '
    echo "--- Verifying Default Route ---"
    CURRENT_ROUTE=$(ip route show default)
    if [ -z "$CURRENT_ROUTE" ]; then
      echo "No default route found. Adding via ${network_gateway}..."
      ip route add default via ${network_gateway}
    else
      echo "Default route exists: $CURRENT_ROUTE"
    fi
    '

  # 3. Debug Network State
  - echo "--- Network State Ready for Bootstrap ---"
  - ip route
  - ping -c 2 8.8.8.8 || echo "Connectivity Check Failed"

  # 4. Run Bootstrap Binary
  - echo "=== Starting Agent Node Bootstrap ==="
  - >
    /usr/local/bin/infra-bootstrap
    --role agent
    --hostname "${hostname}"
    --cloud-env "${cloud_env}"
    --k3s-token "${k3s_token}"
    --k3s-url "${k3s_url}"
    --tailscale-auth-key "${tailscale_auth_agent_key}"
    --network-gateway "${network_gateway}" 2>&1 | tee -a /var/log/infra-bootstrap.log
  - echo "=== Agent Node Bootstrap Complete ==="
