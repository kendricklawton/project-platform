#cloud-config
hostname: ${hostname}
manage_etc_hosts: true

runcmd:
  - echo "Applying Netplan..."
  - netplan apply || echo "Netplan apply failed, continuing..."
  - echo "--- Pre-Bootstrap Network State ---"
  - ip addr
  - ip route
  - ping -c 2 8.8.8.8 || echo "Pre-Bootstrap Connectivity Check Failed"
  - echo "=== Starting Server Node Bootstrap ==="
  - ls -l /usr/local/bin/infra-bootstrap
  - >
    /usr/local/bin/infra-bootstrap
    --role server
    --hostname "${hostname}"
    --cloud-env "${cloud_env}"
    --k3s-token "${k3s_token}"
    --load-balancer-ip "${load_balancer_ip}"
    --tailscale-auth-key "${tailscale_auth_server_key}"
    --tailscale-tag "${tailscale_tag}"
    --init ${k3s_init}
    --s3-bucket "${s3_bucket}"
    --s3-access "${s3_access_key}"
    --s3-secret "${s3_secret_key}"
    --hcloud-token "${hcloud_token}"
    --hcloud-network-name "${hcloud_network_name}"
    --letsencrypt-email "${letsencrypt_email}"
    --network-gateway "${network_gateway}" 2>&1 | tee -a /var/log/infra-bootstrap.log
  - echo "=== Server Node Bootstrap Complete ==="
  - echo "--- Verifying Default Route ---"
  - ip route show default || (echo "Fallback: Adding default route..." && ip route add default via ${network_gateway})
