#cloud-config
hostname: ${hostname}
manage_etc_hosts: true

runcmd:
  # 1. Apply Netplan
  - echo "Applying Netplan..."
  - netplan apply || echo "Netplan apply failed, continuing..."

  # 2. CRITICAL FIX: Ensure Default Route Exists BEFORE Bootstrap
  # We use 'sh -c' to properly handle the if-statement logic in cloud-init
  - |
    sh -c '
    echo "--- Verifying Default Route ---"
    CURRENT_ROUTE=$(ip route show default)
    if [ -z "$CURRENT_ROUTE" ]; then
      echo "No default route found. Adding via ${network_gateway}..."
      ip route add default via ${network_gateway}
    else
      echo "Default route exists: $CURRENT_ROUTE"
    fi
    '

  # 3. Debug Network State (Verify the fix worked)
  - echo "--- Network State Ready for Bootstrap ---"
  - ip route
  - ping -c 2 8.8.8.8 || echo "Connectivity Check Failed (Will retry in bootstrap)"

  # 4. Run Bootstrap Binary
  - echo "=== Starting Server Node Bootstrap ==="
  - ls -l /usr/local/bin/infra-bootstrap
  - >
    /usr/local/bin/infra-bootstrap
    --role server
    --hostname "${hostname}"
    --cloud-env "${cloud_env}"
    --k3s-token "${k3s_token}"
    --load-balancer-ip "${load_balancer_ip}"
    --tailscale-auth-key "${tailscale_auth_server_key}"
    --init ${k3s_init}
    --s3-bucket "${s3_bucket}"
    --s3-access "${s3_access_key}"
    --s3-secret "${s3_secret_key}"
    --hcloud-token "${hcloud_token}"
    --hcloud-network-name "${hcloud_network_name}"
    --letsencrypt-email "${letsencrypt_email}"
    --network-gateway "${network_gateway}" 2>&1 | tee -a /var/log/infra-bootstrap.log
  - echo "=== Server Node Bootstrap Complete ==="
