apiVersion: "cilium.io/v2"
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: "deny-metadata-access"
spec:
  description: "Block access to Hetzner Metadata Service for all non-system pods"
  # Apply to all pods NOT in kube-system
  endpointSelector:
    matchExpressions:
      - key: io.kubernetes.pod.namespace
        operator: NotIn
        values:
          - kube-system
  # Explicitly DROP traffic to the metadata IP
  egressDeny:
    - toCIDR:
        - "169.254.169.254/32"
