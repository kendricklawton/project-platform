apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: main-db
  namespace: project-platform
spec:
  instances: 3

  # 1. Storage
  storage:
    size: 10Gi
    storageClass: hcloud-volumes # Matches your Hetzner setup

  # 2. Backups (Point-in-Time Recovery)
  backup:
    barmanObjectStore:
      destinationPath: "s3://${RegistryS3Bucket}/cnpg-backups/"
      endpointURL: "https://storage.googleapis.com"
      s3Credentials:
        accessKeyId:
          name: cnpg-s3-secret
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: cnpg-s3-secret
          key: SECRET_ACCESS_KEY
      wal:
        compression: gzip

  # 3. Bootstrap (Init DB)
  bootstrap:
    initdb:
      database: app
      owner: appuser
      secret:
        name: main-db-app-auth # CNPG creates this secret with random passwords for you
