#cloud-config
hostname: ${hostname}
manage_etc_hosts: true

write_files:
  # NETPLAN CONFIGURATION
  - path: /etc/netplan/60-custom.yaml
    permissions: "0600"
    content: |
      network:
        version: 2
        ethernets:
          enp7s0:
            dhcp4: true
            nameservers:
              addresses: [1.1.1.1, 8.8.8.8]
            routes:
              - to: 0.0.0.0/0
                via: 10.0.0.1
                on-link: true

  # 2. K3S REGISTRIES: Configured for local platform registry
  - path: /etc/rancher/k3s/registries.yaml
    permissions: "0644"
    content: |
      mirrors:
        "registry.platform-system:5000":
          endpoint:
            - "http://10.43.0.50:5000"

  # 3. KUBERNETES AUDIT POLICY
  - path: /var/lib/rancher/k3s/server/audit.yaml
    permissions: "0600"
    content: |
      apiVersion: audit.k8s.io/v1
      kind: Policy
      rules:
      - level: Metadata

  # 4. MANIFEST INJECTOR: Decoupled for cleaner bootstrap logic
  - path: /usr/local/bin/inject-manifests.sh
    permissions: "0700"
    owner: root:root
    content: |
      #!/bin/bash
      set -e
      echo "[Manifests] Creating directory and decoding payloads..."
      mkdir -p /var/lib/rancher/k3s/server/manifests
      ${indent(6, manifest_injector_script)}

  # 5. OPTIMIZED SERVER BOOTSTRAP SCRIPT
  - path: /usr/local/bin/k3s-start.sh
    permissions: "0700"
    owner: root:root
    content: |
      #!/bin/bash
      set -e

      # ENSURE NETWORK CONNECTIVITY: Force internal routing to NAT and Metadata
      echo "[Bootstrap] Ensuring SDN routing paths..."
      ip route add 169.254.169.254 via 10.0.0.1 dev $(ip -4 route show to default | awk '{print $5}') onlink || true
      ip route add default via 10.0.0.1 dev $(ip -4 route show to default | awk '{print $5}') onlink || true

      echo "[Bootstrap] Injecting Cluster Manifests..."
      /usr/local/bin/inject-manifests.sh

      echo "[Bootstrap] Waiting for Internet and Metadata services..."
      for i in {1..30}; do
        if curl -s -m 2 http://169.254.169.254/hetzner/v1/metadata/instance-id >/dev/null; then break; fi
        echo "Waiting for Hetzner Metadata API..."
        sleep 2
      done

      HCLOUD_ID=$(curl -s http://169.254.169.254/hetzner/v1/metadata/instance-id)
      if [ -z "$HCLOUD_ID" ]; then
        echo "CRITICAL: Metadata service unreachable."
        exit 1
      fi

      echo "[Bootstrap] Waiting for Tailscale IP..."
      for i in {1..30}; do
        TS_IP=$(tailscale ip -4 2>/dev/null || true)
        if [ -n "$TS_IP" ]; then break; fi
        sleep 2
      done

      if [ -z "$TS_IP" ]; then
        echo "CRITICAL: Tailscale IP timeout."
        exit 1
      fi

      echo "[Bootstrap] Generating K3s Node Configuration..."
      mkdir -p /etc/rancher/k3s
      cat > /etc/rancher/k3s/config.yaml <<EOF
      token: ${k3s_token}
      node-ip: $(hostname -I | awk '{print $1}')
      node-external-ip: $TS_IP
      tls-san:
        - ${hostname}
        - $TS_IP
        - ${k3s_load_balancer_ip}
      flannel-backend: none
      disable-network-policy: true
      disable:
        - traefik
        - servicelb
        - cloud-controller
      disable-cloud-controller: true
      etcd-s3: true
      etcd-s3-endpoint: storage.googleapis.com
      etcd-s3-access-key: ${etcd_s3_access_key}
      etcd-s3-secret-key: ${etcd_s3_secret_key}
      etcd-s3-bucket: ${etcd_s3_bucket}
      etcd-snapshot-schedule-cron: "0 */6 * * *"
      etcd-snapshot-retention: 10
      kubelet-arg:
        - "cloud-provider=external"
        - "provider-id=hcloud://$HCLOUD_ID"
        - "container-log-max-files=3"
        - "container-log-max-size=10Mi"
      ${k3s_cluster_setting}
      EOF

      echo "[Bootstrap] Initializing K3s Service..."
      systemctl stop k3s || true
      fuser -k 10258/tcp || true
      systemctl enable k3s
      systemctl restart k3s

      echo "[Bootstrap] Monitoring Node Registration..."
      export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
      for i in {1..60}; do
        if kubectl get node ${hostname} >/dev/null 2>&1; then
          echo "Node ${hostname} registered successfully."
          break
        fi
        sleep 5
      done
      echo "=== K3s Server Bootstrap Complete ==="

runcmd:
  # 1. Network Initialization
  - netplan generate
  - netplan apply
  - sleep 5
  - systemctl restart systemd-resolved || true

  # 2. Tailscale Join: Optimized with socket check and exponential backoff logic
  - |
    LOG="/var/log/tailscale-join.log"
    echo "Starting Tailscale join..." > $LOG
    for i in $(seq 1 10); do
      if [ -S /run/tailscale/tailscaled.sock ]; then break; fi
      echo "Waiting for tailscaled socket..." >> $LOG
      sleep 3
    done

    until tailscale up \
      --authkey=${tailscale_auth_k3s_server_key} \
      --ssh \
      --hostname=${hostname} \
      --advertise-tags="tag:k3s-server" \
      --reset >> $LOG 2>&1; do
      echo "Tailscale up failed, retrying in 5s..." >> $LOG
      sleep 5
    done

  # 3. Final K3s Initialization
  - /usr/local/bin/k3s-start.sh
