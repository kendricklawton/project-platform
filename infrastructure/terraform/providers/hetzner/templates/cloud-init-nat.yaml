#cloud-config
hostname: ${hostname}
manage_etc_hosts: true

write_files:
  # Private network interface â€” DHCP but don't steal the default route
  - path: /etc/netplan/60-private-net.yaml
    permissions: "0600"
    content: |
      network:
        version: 2
        ethernets:
          private:
            match:
              name: "e*"
            dhcp4: true
            dhcp4-overrides:
              use-routes: false
            routes:
            - to: 10.0.0.1
              scope: link
            - to: 10.0.0.0/16
              via: 10.0.0.1

runcmd:
  # 1. Apply private network netplan
  - netplan generate
  - netplan apply
  - sleep 5

  # 2. Force IP Forwarding & Disable UFW (just in case)
  - sysctl -w net.ipv4.ip_forward=1
  - systemctl stop ufw || true
  - systemctl disable ufw || true

  # 3. Native IPTables Injection (Bulletproof)
  - |
    WAN_IFACE=$(ip route show default | awk '{print $5}' | head -n1)
    [ -z "$WAN_IFACE" ] && WAN_IFACE="eth0"
    echo "WAN interface: $WAN_IFACE" >> /var/log/nat-setup.log

    # Flush forward/postrouting to avoid duplicates, then hardcode the NAT rules
    iptables -F FORWARD
    iptables -t nat -F POSTROUTING
    iptables -A FORWARD -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
    iptables -A FORWARD -s 10.0.0.0/16 -j ACCEPT
    iptables -t nat -A POSTROUTING -o $WAN_IFACE -j MASQUERADE
    netfilter-persistent save

  # 4. Join Tailscale
  - |
    echo "Waiting for tailscaled socket..." >> /var/log/tailscale-join.log
    for i in $(seq 1 12); do
      [ -S /run/tailscale/tailscaled.sock ] && break
      sleep 5
    done
    echo "tailscaled socket ready, joining..." >> /var/log/tailscale-join.log
  - |
    NEXT_WAIT=0
    until tailscale up \
      --authkey=${tailscale_auth_nat_key} \
      --ssh \
      --hostname=${hostname} \
      --advertise-tags="tag:nat" \
      --reset >> /var/log/tailscale-join.log 2>&1 \
      || [ $NEXT_WAIT -eq 12 ]; do
      sleep 5
      NEXT_WAIT=$((NEXT_WAIT+1))
    done
