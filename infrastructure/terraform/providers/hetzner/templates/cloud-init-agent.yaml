#cloud-config
hostname: ${hostname}
manage_etc_hosts: true

write_files:
  # NETPLAN CONFIGURATION: Fixed indentation for the routes block
  - path: /etc/netplan/60-custom.yaml
    permissions: "0600"
    content: |
      network:
        version: 2
        ethernets:
          enp7s0:
            dhcp4: true
            nameservers:
              addresses: [1.1.1.1, 8.8.8.8]
            routes:
              - to: 0.0.0.0/0
                via: 10.0.0.1
                on-link: true

  # K3S REGISTRIES: Configured for your local platform registry
  - path: /etc/rancher/k3s/registries.yaml
    permissions: "0644"
    content: |
      mirrors:
        "registry.platform-system:5000":
          endpoint:
            - "http://10.43.0.50:5000"

  # GVISOR CONFIGURATION: Template for containerd to recognize the runsc runtime
  - path: /var/lib/rancher/k3s/agent/etc/containerd/config.toml.tmpl
    permissions: "0644"
    content: |
      [plugins.opt]
        path = "{{ .NodeConfig.Containerd.Opt }}"
      [plugins.cri]
        stream_server_address = "127.0.0.1"
        stream_server_port = "10010"
        enable_selinux = {{ .NodeConfig.SELinux }}
      [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runsc]
        runtime_type = "io.containerd.runsc.v1"

  # OPTIMIZED AGENT BOOTSTRAP SCRIPT
  - path: /usr/local/bin/k3s-start.sh
    permissions: "0700"
    owner: root:root
    content: |
      #!/bin/bash
      set -e

      echo "[Bootstrap] Ensuring SDN routing paths..."
      IFACE=$(ip -4 route show to default | awk '{print $5}')
      # Ensure we have a route to the NAT gateway even if netplan is slow
      ip route add default via 10.0.0.1 dev $IFACE onlink || true

      echo "[Bootstrap] Waiting for Internet connectivity..."
      for i in {1..30}; do
        if ping -c 1 8.8.8.8 >/dev/null 2>&1; then break; fi
        echo "Waiting for NAT gateway (10.0.0.1)..."
        sleep 2
      done

      echo "[Bootstrap] Waiting for Tailscale IP..."
      for i in {1..30}; do
        TS_IP=$(tailscale ip -4 2>/dev/null || true)
        if [ -n "$TS_IP" ]; then break; fi
        echo "Waiting for Tailscale interface..."
        sleep 2
      done

      if [ -z "$TS_IP" ]; then
        echo "CRITICAL: Tailscale IP timeout."
        exit 1
      fi

      echo "[Bootstrap] Generating K3s Agent Configuration..."
      mkdir -p /etc/rancher/k3s
      cat > /etc/rancher/k3s/config.yaml <<EOF
      server: https://${k3s_control_plane_url}
      token: ${k3s_token}
      node-ip: $(hostname -I | awk '{print $1}')
      node-external-ip: $TS_IP
      kubelet-arg:
        - "cloud-provider=external"
        - "container-log-max-files=3"
        - "container-log-max-size=10Mi"
      EOF

      echo "[Bootstrap] Starting K3s Agent (Packer-baked service)..."
      systemctl daemon-reload
      systemctl enable k3s-agent
      systemctl restart k3s-agent
      echo "=== K3s Agent Bootstrap Complete ==="

runcmd:
  # Network Initialization
  - netplan generate
  - netplan apply
  - sleep 5
  - systemctl restart systemd-resolved || true

  # Join Tailscale
  - |
    LOG="/var/log/tailscale-join.log"
    echo "Starting Tailscale join..." > $LOG
    for i in $(seq 1 10); do
      if [ -S /run/tailscale/tailscaled.sock ]; then break; fi
      sleep 3
    done

    until tailscale up \
      --authkey=${tailscale_auth_k3s_agent_key} \
      --ssh \
      --hostname=${hostname} \
      --advertise-tags="tag:k3s-agent" \
      --reset >> $LOG 2>&1; do
      echo "Tailscale join failed, retrying..." >> $LOG
      sleep 5
    done

  # Final Agent Initialization
  - /usr/local/bin/k3s-start.sh
