version: "3"

dotenv: [".env"]

vars:
  PROJECT_NAME: "project-platform"

  # PACKER CONFIG
  PACKER_DIR: "infra/packer"
  PACKER_IMAGE: "ubuntu-22-04-x64"

  # Packer & Terraform Variables - DigitalOcean
  DOCLOUD_NAT_IMAGE: "ubuntu-22-04-x64"
  DOCLOUD_NAT_TYPE: "s-1vcpu-1gb"
  DOCLOUD_MASTER_TYPE: "s-4vcpu-8gb"
  DOCLOUD_WORKER_TYPE: "s-4vcpu-8gb"
  DOCLOUD_LB_TYPE: "s-4vcpu-8gb" # ???

  # Packer & Terraform Variables - Hetzner
  HCLOUD_NAT_IMAGE: "ubuntu-22.04"
  HCLOUD_NAT_TYPE: "cpx11"
  HCLOUD_MASTER_TYPE: "cpx31"
  HCLOUD_WORKER_TYPE: "cpx31"
  HCLOUD_LB_TYPE: "lb11"

  # COMPONENT VERSIONS
  K3S_VERSION: "v1.29.1+k3s2"
  GVISOR_VERSION: "latest"
  HETZNER_CCM_VERSION: "1.29.1"
  HETZNER_CSI_VERSION: "2.6.0"
  DIGITALOCEAN_CCM_VERSION: "0.1.58"
  DIGITALOCEAN_CSI_VERSION: "4.8.0"
  CILIUM_VERSION: "1.15.1"
  CNPG_VERSION: "1.28.1"
  INGRESS_NGINX_VERSION: "4.10.0"
  CERT_MANAGER_VERSION: "v1.14.0"
  NATS_VERSION: "2.10.12"
  KUBEARMOR_VERSION: "1.3.1"
  KYVERNO_VERSION: "3.2.6"
  FLUENT_BIT_VERSION: "3.0.0"
  VM_VERSION: "0.14.0"
  LOKI_VERSION: "5.43.3"
  GRAFANA_VERSION: "7.3.0"
  ARGOCD_VERSION: "6.7.11"
  KNATIVE_VERSION: "1.14.0"

  # Database Defaults
  DATABASE_URL: "{{.DATABASE_URL}}"

tasks:
  # GCP SECRET MANAGEMENT (Manual Seeding)
  # Usage: task gcp:secret:set NAME=registry-s3-key VALUE=your-actual-key
  gcp:secret:set:
    desc: "Push a secret value to GCP Secret Manager"
    cmds:
      - |
        if ! gcloud secrets list --filter="name:{{.NAME}}" --project {{.GCP_PROJECT_ID}} | grep -q {{.NAME}}; then
          gcloud secrets create {{.NAME}} --replication-policy="automatic" --project {{.GCP_PROJECT_ID}}
        fi
      - echo -n "{{.VALUE}}" | gcloud secrets versions add {{.NAME}} --data-file=- --project {{.GCP_PROJECT_ID}}
    requires:
      vars: [NAME, VALUE]

  gcp:secret:list:
    desc: "List all platform secrets in GCP"
    cmds:
      - gcloud secrets list --project {{.GCP_PROJECT_ID}}

  # PACKER WORKFLOWS
  _packer_build:
    internal: true
    silent: true
    desc: "Generic Packer Build Wrapper"
    env:
      PKR_VAR_hcloud_token: "{{.HCLOUD_TOKEN}}"
      PKR_VAR_docloud_token: "{{.DOCLOUD_TOKEN}}"
    cmds:
      - packer init {{.PACKER_DIR}}
      - >-
        packer build {{.BUILD_ARGS}}
        -var "docloud_nat_image={{.DOCLOUD_NAT_IMAGE}}"
        -var "docloud_nat_type={{.DOCLOUD_NAT_TYPE}}"
        -var "hcloud_nat_image={{.HCLOUD_NAT_IMAGE}}"
        -var "hcloud_nat_type={{.HCLOUD_NAT_TYPE}}"
        {{.PACKER_DIR}}/ubuntu.pkr.hcl

  packer:hz:
    desc: "Build Hetzner Images Only"
    cmds:
      - task: _packer_build
        vars: { BUILD_ARGS: "-only=*.hcloud.*" }

  packer:do:
    desc: "Build DigitalOcean Images Only"
    cmds:
      - task: _packer_build
        vars: { BUILD_ARGS: "-only=*.digitalocean.*" }

  packer:all:
    desc: "Build Both Hetzner and DigitalOcean Images"
    cmds:
      - task: _packer_build
        vars: { BUILD_ARGS: "" }

  # TERRAFORM CORE ENGINE
  _tf:
    internal: true
    dir: infra/terraform/providers/{{.PROVIDER}}
    vars:
      TFSTATE_BUCKET: "{{.PROJECT_NAME}}-tfstate-{{.CLOUD_ENV}}"
      CCM_VERSION: '{{if eq .PROVIDER "hetzner"}}{{.HETZNER_CCM_VERSION}}{{else}}{{.DIGITALOCEAN_CCM_VERSION}}{{end}}'
      CSI_VERSION: '{{if eq .PROVIDER "hetzner"}}{{.HETZNER_CSI_VERSION}}{{else}}{{.DIGITALOCEAN_CSI_VERSION}}{{end}}'
    env:
      GOOGLE_APPLICATION_CREDENTIALS: "{{.TASKFILE_DIR}}/keys/{{.PROJECT_NAME}}-tfstate-{{.CLOUD_ENV}}.json"
      DIGITALOCEAN_TOKEN: "{{.DOCLOUD_TOKEN}}"
      HCLOUD_TOKEN: "{{.HCLOUD_TOKEN}}"

      # TF_VAR Data
      TF_VAR_token: '{{if eq .PROVIDER "hetzner"}}{{.HCLOUD_TOKEN}}{{else}}{{.DOCLOUD_TOKEN}}{{end}}'
      TF_VAR_nat_type: '{{if eq .PROVIDER "hetzner"}}{{.HCLOUD_NAT_TYPE}}{{else}}{{.DOCLOUD_NAT_TYPE}}{{end}}'
      TF_VAR_master_type: '{{if eq .PROVIDER "hetzner"}}{{.HCLOUD_MASTER_TYPE}}{{else}}{{.DOCLOUD_MASTER_TYPE}}{{end}}'
      TF_VAR_worker_type: '{{if eq .PROVIDER "hetzner"}}{{.HCLOUD_WORKER_TYPE}}{{else}}{{.DOCLOUD_WORKER_TYPE}}{{end}}'
      TF_VAR_load_balancer_type: '{{if eq .PROVIDER "hetzner"}}{{.HCLOUD_LB_TYPE}}{{else}}{{.DOCLOUD_LB_TYPE}}{{end}}'
      TF_VAR_location: "{{.LOCATION}}"
      TF_VAR_project_name: "{{.PROJECT_NAME}}"
      TF_VAR_cloud_env: "{{.CLOUD_ENV}}"
      TF_VAR_ssh_key_name: '{{if eq .PROVIDER "hetzner"}}{{.HETZNER_SSH_KEY_NAME}}{{else}}{{.DIGITALOCEAN_SSH_KEY_NAME}}{{end}}'
      TF_VAR_github_repo_url: "{{.GITHUB_REPO_URL}}"
      TF_VAR_tailscale_oauth_client_id: "{{.TAILSCALE_OAUTH_CLIENT_ID}}"
      TF_VAR_tailscale_oauth_client_secret: "{{.TAILSCALE_OAUTH_CLIENT_SECRET}}"
      TF_VAR_tailscale_auth_nat_key: "{{.TAILSCALE_AUTH_NAT_KEY}}"
      TF_VAR_etcd_s3_bucket: "{{.PROJECT_NAME}}-etcd-{{.CLOUD_ENV}}"
      TF_VAR_etcd_s3_region: "{{.S3_REGION}}"
      TF_VAR_etcd_s3_endpoint: "https://storage.googleapis.com"
      TF_VAR_etcd_s3_access_key: "{{.ETCD_S3_ACCESS_KEY}}"
      TF_VAR_etcd_s3_secret_key: "{{.ETCD_S3_SECRET_KEY}}"

      # Component Versions
      TF_VAR_ccm_version: "{{.CCM_VERSION}}"
      TF_VAR_csi_version: "{{.CSI_VERSION}}"
      TF_VAR_ingress_nginx_version: "{{.INGRESS_NGINX_VERSION}}"
      TF_VAR_cilium_version: "{{.CILIUM_VERSION}}"
      TF_VAR_argocd_version: "{{.ARGOCD_VERSION}}"
    cmds:
      - echo "[TERRAFORM] {{.CMD}} -> {{.PROVIDER}} -> {{.LOCATION}} -> {{.CLOUD_ENV}}"
      - terraform init -reconfigure -backend-config="bucket={{.TFSTATE_BUCKET}}" -backend-config="prefix={{.PROVIDER}}"
      - terraform {{.CMD}} {{.ARGS}}

  # HETZNER INFRASTRUCTURE
  hz:plan:
    desc: "Plan Hetzner Ashburn (Dev)"
    cmds:
      - task: _tf
        vars:
          PROVIDER: "hetzner"
          LOCATION: "ash"
          CLOUD_ENV: "dev"
          CMD: "plan"
          ARGS: "-out=tfplan"

  hz:apply:
    desc: "Apply Hetzner Ashburn (Dev)"
    cmds:
      - task: _tf
        vars:
          PROVIDER: "hetzner"
          LOCATION: "ash"
          CLOUD_ENV: "dev"
          CMD: "apply"
          ARGS: "-auto-approve tfplan"

  hz:destroy:
    desc: "Destroy Hetzner Ashburn (Dev)"
    cmds:
      - task: _tf
        vars:
          PROVIDER: "hetzner"
          LOCATION: "ash"
          CLOUD_ENV: "dev"
          CMD: "destroy"
          ARGS: "-auto-approve"

  hz:output:
    desc: "Show Hetzner Outputs"
    cmds:
      - task: _tf
        vars:
          PROVIDER: "hetzner"
          LOCATION: "ash"
          CLOUD_ENV: "dev"
          CMD: "output"
          ARGS: ""

  hz:kubeconfig:
    desc: "Write Hetzner Kubeconfig to disk"
    cmds:
      - mkdir -p ~/.kube
      - terraform -chdir=infra/terraform/providers/hetzner output -raw kubeconfig > ~/.kube/config
      - chmod 600 ~/.kube/config
      - echo "✅ Kubeconfig successfully written to ~/.kube/config"

  hz:talosconfig:
    desc: "Write Hetzner Talosconfig to disk"
    cmds:
      - mkdir -p ~/.talos
      - terraform -chdir=infra/terraform/providers/hetzner output -raw talosconfig > ~/.talos/config
      - chmod 600 ~/.talos/config
      - echo "✅ Talosconfig successfully written to ~/.talos/config"

  # DIGITALOCEAN INFRASTRUCTURE
  do:plan:
    desc: "Plan DigitalOcean NYC3 (Dev)"
    cmds:
      - task: _tf
        vars:
          PROVIDER: "digitalocean"
          LOCATION: "nyc3"
          CLOUD_ENV: "dev"
          CMD: "plan"
          ARGS: "-out=tfplan"

  do:apply:
    desc: "Apply DigitalOcean NYC3 (Dev)"
    cmds:
      - task: _tf
        vars:
          PROVIDER: "digitalocean"
          LOCATION: "nyc3"
          CLOUD_ENV: "dev"
          CMD: "apply"
          ARGS: "-auto-approve tfplan"

  do:destroy:
    desc: "Destroy DigitalOcean NYC3 (Dev)"
    cmds:
      - task: _tf
        vars:
          PROVIDER: "digitalocean"
          LOCATION: "nyc3"
          CLOUD_ENV: "dev"
          CMD: "destroy"
          ARGS: "-auto-approve"

  do:output:
    desc: "Show DigitalOcean Outputs"
    cmds:
      - task: _tf
        vars:
          PROVIDER: "digitalocean"
          LOCATION: "nyc3"
          CLOUD_ENV: "dev"
          CMD: "output"
          ARGS: ""

  # BUILD WORKFLOWS (Choice of ko or Docker)
  build:ko:api:
    desc: "Build the API container image using ko (Go-optimized)"
    dir: core
    env:
      KO_DOCKER_REPO: '{{.KO_DOCKER_REPO | default "ko.local"}}'
    cmds:
      - ko build ./cmd/platform-api --bare

  build:ko:cli:
    desc: "Build the CLI container image using ko (Go-optimized)"
    dir: core
    env:
      KO_DOCKER_REPO: '{{.KO_DOCKER_REPO | default "ko.local"}}'
    cmds:
      - ko build ./cmd/platform-cli --bare

  build:docker:api:
    desc: "Build the API container image using Docker"
    dir: core
    cmds:
      - docker build -t project-platform-api:latest --build-arg SERVICE_NAME=platform-api .

  build:docker:cli:
    desc: "Build the CLI container image using Docker"
    dir: core
    cmds:
      - docker build -t project-platform-cli:latest --build-arg SERVICE_NAME=platform-cli .

  # WEB APP WORKFLOWS
  web:dev:
    desc: "Show Web App"
    dir: web
    cmds:
      - npm run dev

  # DATABASE WORKFLOWS
  db:up:
    desc: "Start local PostgreSQL database"
    cmds:
      - docker compose up -d db

  db:down:
    desc: "Stop local PostgreSQL database"
    cmds:
      - docker compose down

  db:migrate:
    desc: "Run database migrations (up)"
    silent: true
    cmds:
      - go install -tags 'postgres' github.com/golang-migrate/migrate/v4/cmd/migrate@latest
      - migrate -path database/migrations -database "{{.DATABASE_URL}}" up

  db:migrate-down:
    desc: "Rollback the last database migration (down 1)"
    cmds:
      - migrate -path database/migrations -database "{{.DATABASE_URL}}" down 1

  db:create-migration:
    desc: "Create a new migration (usage: task db:create-migration NAME=create_users)"
    cmds:
      - migrate create -ext sql -dir database/migrations -seq {{.NAME}}
    requires:
      vars: [NAME]

  db:generate:
    desc: "Generate Go code from SQL using sqlc"
    dir: database
    cmds:
      - sqlc generate

  db:setup:
    desc: "Spin up DB, wait, migrate, and generate code"
    cmds:
      - task: db:up
      - echo "Waiting for DB to be ready..."
      - sleep 5
      - task: db:migrate
      - task: db:generate

  db:login:
    desc: "Login to the local PostgreSQL database"
    cmds:
      - docker exec -it project-platform-db-1 psql -U platform platform_db
